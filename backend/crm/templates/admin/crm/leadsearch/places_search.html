{% extends "admin/base_site.html" %}
{% load i18n admin_urls %}

{% block content %}
<style>
    .places-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 30px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .places-container h2 { margin-bottom: 20px; color: #1f2937; }
    .info-box {
        background: #eff6ff;
        border: 1px solid #3b82f6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .info-box strong { color: #1e40af; }
    .search-form {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr auto auto;
        gap: 12px;
        align-items: end;
        margin-bottom: 24px;
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-weight: 600; font-size: 13px; color: #374151; }
    .form-group select, .form-group input {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }
    .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 12px 16px;
        background: #f0fdf4;
        border: 1px solid #22c55e;
        border-radius: 8px;
    }
    .stat { font-size: 14px; }
    .stat strong { color: #166534; }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    .results-table th {
        background: #f9fafb;
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    .results-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: top;
    }
    .results-table tr:hover { background: #f9fafb; }
    .website-yes { color: #16a34a; font-weight: 600; }
    .website-no { color: #dc2626; font-weight: 700; }
    .email-found { color: #16a34a; font-weight: 600; font-size: 12px; word-break: break-all; }
    .email-none { color: #9ca3af; }
    .rating-stars { color: #eab308; }
    .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .select-controls { margin-bottom: 12px; font-size: 13px; }
    .select-controls a { color: #3b82f6; cursor: pointer; text-decoration: underline; margin-right: 12px; }
    .loading-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255,255,255,0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .loading-overlay.active { display: flex; }
    .loading-box {
        background: #fff;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        text-align: center;
    }
    .spinner {
        width: 40px; height: 40px;
        border: 4px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-box p { color: #374151; font-size: 15px; font-weight: 600; margin: 0; }
    .loading-box small { color: #6b7280; font-size: 13px; }
</style>

<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-box">
        <div class="spinner"></div>
        <p>Searching Google Places...</p>
        <small>Fetching details & emails for each business. This may take 15-30 seconds.</small>
    </div>
</div>

<div class="places-container">
    <h2>Search Google Places for Leads</h2>

    <div class="info-box">
        <strong>How it works:</strong> Search for local businesses by industry and location.
        Use keywords to narrow results (e.g. "Indian", "Pakistani" for ethnic-specific businesses).
        We'll grab phone, website, and email for each result automatically.
    </div>

    <!-- Search Form -->
    <form method="post" id="searchForm">
        {% csrf_token %}
        <input type="hidden" name="do_search" value="1">

        <div class="search-form">
            <div class="form-group">
                <label>Brand *</label>
                <select name="brand" required>
                    <option value="">Select Brand</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {% if brand.id|stringformat:"s" == brand_id %}selected{% endif %}>{{ brand.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Industry</label>
                <select name="industry">
                    <option value="">All Industries</option>
                    {% for value, label in industry_choices %}
                    <option value="{{ value }}" {% if value == industry %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Keywords</label>
                <input type="text" name="keywords" placeholder="e.g. Indian, Pakistani, Nepali" value="{{ keywords|default:'' }}">
            </div>
            <div class="form-group">
                <label>Location *</label>
                <input type="text" name="location" placeholder="e.g. Parramatta NSW" value="{{ location|default:'' }}" required>
            </div>
            <div class="form-group">
                <label>Radius (km)</label>
                <input type="number" name="radius_km" min="1" max="50" value="{{ radius_km|default:'5' }}" style="width: 80px;">
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-primary" id="searchBtn">Search</button>
            </div>
        </div>
    </form>

    {% if show_results %}
    <!-- Results -->
    <div class="stats-bar">
        <div class="stat">Found <strong>{{ total }}</strong> businesses</div>
        <div class="stat"><strong>{{ with_email }}</strong> with email</div>
        <div class="stat"><strong>{{ with_phone }}</strong> with phone</div>
        <div class="stat"><strong>{{ without_website }}</strong> without a website</div>
    </div>

    {% if businesses %}
    <form method="post" id="importForm">
        {% csrf_token %}
        <input type="hidden" name="search_id" value="{{ search_id }}">
        <input type="hidden" name="brand_id" value="{{ brand_id }}">

        <div class="select-controls">
            <a onclick="selectAll()">Select All</a>
            <a onclick="selectNone()">Select None</a>
            <a onclick="selectWithEmail()">Select With Email</a>
            <a onclick="selectWithPhone()">Select With Phone</a>
            <a onclick="selectNoWebsite()">Select Without Website</a>
        </div>

        <table class="results-table">
            <thead>
                <tr>
                    <th style="width: 30px;"><input type="checkbox" id="selectAllCb" onchange="toggleAll(this)"></th>
                    <th>Business Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Website</th>
                    <th>Rating</th>
                </tr>
            </thead>
            <tbody>
                {% for biz in businesses %}
                <tr data-has-website="{{ biz.has_website|yesno:'yes,no' }}" data-has-email="{{ biz.email|yesno:'yes,no' }}" data-has-phone="{{ biz.phone|yesno:'yes,no' }}">
                    <td>
                        <input type="checkbox" name="selected_places"
                               value="{{ biz.json_value }}"
                               class="place-cb">
                    </td>
                    <td><strong>{{ biz.name }}</strong></td>
                    <td>
                        {% if biz.email %}
                            <span class="email-found">{{ biz.email }}</span>
                        {% else %}
                            <span class="email-none">-</span>
                        {% endif %}
                    </td>
                    <td>{{ biz.phone|default:"-" }}</td>
                    <td style="max-width: 220px;">{{ biz.address|default:"-" }}</td>
                    <td>
                        {% if biz.has_website %}
                            <span class="website-yes">Has website</span>
                        {% else %}
                            <span class="website-no">NO WEBSITE</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if biz.rating %}
                            <span class="rating-stars">{{ biz.rating }}</span>
                            <span style="color: #6b7280; font-size: 12px;">({{ biz.user_ratings_total }})</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="display: flex; align-items: end; gap: 16px; margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
            <div class="form-group" style="min-width: 200px;">
                <label>Pipeline (optional)</label>
                <select name="pipeline">
                    <option value="">No pipeline</option>
                    {% for p in pipelines %}
                    <option value="{{ p.id }}">{{ p.name }} ({{ p.brand.name }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" name="do_import" class="btn btn-success">
                Import as Contacts
            </button>
            <button type="submit" name="do_import_and_compose" class="btn btn-primary">
                Import & Open in Email Composer
            </button>
            <button type="submit" name="do_import_and_sms" class="btn btn-primary" style="background:#8b5cf6;">
                Import & Open in SMS Composer
            </button>
            <a href="{% url 'admin:crm_leadsearch_changelist' %}" class="btn btn-secondary">
                Back
            </a>
        </div>
    </form>
    {% else %}
    <p style="color: #6b7280; padding: 20px 0;">No businesses found. Try a different location or industry.</p>
    {% endif %}
    {% endif %}
</div>

<script>
document.getElementById('searchForm').addEventListener('submit', function() {
    document.getElementById('loadingOverlay').classList.add('active');
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('searchBtn').textContent = 'Searching...';
});

function toggleAll(cb) {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = cb.checked; });
}
function selectAll() {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = true; });
    document.getElementById('selectAllCb').checked = true;
}
function selectNone() {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = false; });
    document.getElementById('selectAllCb').checked = false;
}
function selectWithEmail() {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = false; });
    document.querySelectorAll('tr[data-has-email="yes"] .place-cb').forEach(function(el) { el.checked = true; });
}
function selectWithPhone() {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = false; });
    document.querySelectorAll('tr[data-has-phone="yes"] .place-cb').forEach(function(el) { el.checked = true; });
}
function selectNoWebsite() {
    document.querySelectorAll('.place-cb').forEach(function(el) { el.checked = false; });
    document.querySelectorAll('tr[data-has-website="no"] .place-cb').forEach(function(el) { el.checked = true; });
}
</script>
{% endblock %}
